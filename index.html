<!doctype html>
<html lang="en">
	<head>
		<title>Wagner - Minefield!</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: #ffffff;
				font-family:Monospace;
				font-size:13px;
				text-align:center;
				font-weight: bold;
				background-color: #111;
				background-image: url( escheresque_ste.png );
				margin: 0px;
				overflow: hidden;
			}
			#container canvas{ width: 100%; height: 100%;}
			#fullscreenBtn{ position: absolute; right: 10px; top: 10px; color :white; border: 1px solid white; border-radius: 4px; padding: 20px; text-decoration: none;}
			#fullscreenBtn:hover{ color: black; background-color: white;}
		</style>
	</head>
	<body>

		<div id="container"></div>
		<a href="#" id="fullscreenBtn" >Go fullscreen</a>

<script src="js/three.min.js"></script>
<script src="http://spite.github.io/rstats/rStats.js" ></script>
<script src="Wagner.js"></script>

<script>

'use strict'

var composer;

var rS = new rStats( {
	values: {
		frame: { caption: 'Total frame time (ms)', over: 16 },
        raf: { caption: 'Time since last rAF (ms)' },
        fps: { caption: 'Framerate (FPS)', below: 30 }
	}
} );

var links = document.querySelectorAll( 'a[rel=external]' );
for( var j = 0; j < links.length; j++ ) {
    var a = links[ j ];
    a.addEventListener( 'click', function( e ) {
        window.open( this.href, '_blank' );
        e.preventDefault();
    }, false );
}

var container, renderer, scene, camera, mesh, torus, material, fov = 70;
var model, quad;

var invertPass, boxBlurPass, fullBoxBlurPass, zoomBlurPass, multiPassBloomPass, denoisePass, 
	sepiaPass, noisePass, vignettePass, vignette2Pass, CGAPass, edgeDetectionPass,
	dirtPass, blendPass, guidedFullBoxBlurPass;

var tmpTexture;
var depthMaterial = new THREE.MeshDepthMaterial();
var modelMaterial = new THREE.MeshBasicMaterial( { map: THREE.ImageUtils.loadTexture( 'util.png' ), emissive: 0xffffff, wireframe: false } )


var c = document.body;
document.getElementById( 'fullscreenBtn' ).addEventListener( 'click', function( e ) {
	c.onwebkitfullscreenchange = function(e) {
		c.onwebkitfullscreenchange = function() {
		};
	};
	c.onmozfullscreenchange = function(e) {
		c.onmozfullscreenchange = function() {
		};
	};
	if( c.webkitRequestFullScreen ) c.webkitRequestFullScreen();
	if( c.mozRequestFullScreen ) c.mozRequestFullScreen();
	e.preventDefault();
}, false );

window.addEventListener( 'load', function() {

	init();
	
} );

function init() {

	container = document.getElementById( 'container' );
	
	scene = new THREE.Scene();

	camera = new THREE.PerspectiveCamera( fov, window.innerWidth / window.innerHeight, 1, 10000 );
	camera.position.z = 1000;
	scene.add( camera );

	renderer = new THREE.WebGLRenderer( { antialias: true, alpha: false } );
	renderer.setSize( window.innerWidth, window.innerHeight );

	container.appendChild( renderer.domElement );

	document.addEventListener( 'mousemove', onDocumentMouseMove, false );
	container.addEventListener( 'mousewheel', onMouseWheel, false );
	container.addEventListener( 'DOMMouseScroll', onMouseWheel, false);
	window.addEventListener( 'resize', onWindowResize, false );

	var useTeapot = false;

	if( useTeapot ) {
		
		var loader = new THREE.JSONLoader();
		loader.load( 'teapot.js', function( data ) { 
			data.computeCentroids();
			data.computeFaceNormals();
			data.computeVertexNormals();
			THREE.GeometryUtils.center( data );
			model = new THREE.Mesh( 
				data,
				modelMaterial
			);
			model.scale.set ( 10, 10, 10 );
			scene.add( model );
		} );

	} else {

		model = new THREE.Mesh( 
			new THREE.TorusKnotGeometry( 300, 100, 200, 50, 1, 3 ), 
			modelMaterial
		);
		model.material.map.wrapS = model.material.map.wrapT = THREE.RepeatWrapping;
		model.material.map.repeat.set( 4, 2 );
		model.scale.set( 4, 4,4 );
		scene.add( model );

	}

	composer = new WAGNER.Composer( renderer, { useRGBA: false } );

	invertPass = new WAGNER.InvertPass();
	boxBlurPass = new WAGNER.BoxBlurPass();
	fullBoxBlurPass = new WAGNER.FullBoxBlurPass();
	zoomBlurPass = new WAGNER.ZoomBlurPass();
	multiPassBloomPass = new WAGNER.MultiPassBloomPass();
	denoisePass = new WAGNER.DenoisePass();
	sepiaPass = new WAGNER.SepiaPass();
	noisePass = new WAGNER.NoisePass();
	vignettePass = new WAGNER.VignettePass();
	vignette2Pass = new WAGNER.Vignette2Pass();
	CGAPass = new WAGNER.CGAPass();
	edgeDetectionPass = new WAGNER.EdgeDetectionPass();
	dirtPass = new WAGNER.DirtPass();
	blendPass = new WAGNER.BlendPass();
	guidedFullBoxBlurPass = new WAGNER.GuidedFullBoxBlurPass();

	onWindowResize();

	render();
	
}

function onWindowResize() {

	var s = 1,
		w = window.innerWidth,
		h = window.innerHeight;

	renderer.setSize( s * w, s * h );
	camera.projectionMatrix.makePerspective( fov, w / h, camera.near, camera.far );
	composer.setSize( w, h );
	tmpTexture = WAGNER.Pass.prototype.getOfflineTexture( w, h );

}

function onMouseWheel( event ) {

	// WebKit

	if ( event.wheelDeltaY ) {

		fov -= event.wheelDeltaY * 0.05;

	// Opera / Explorer 9

	} else if ( event.wheelDelta ) {

		fov -= event.wheelDelta * 0.05;

	// Firefox

	} else if ( event.detail ) {

		fov += event.detail * 1.0;

	}

	camera.projectionMatrix.makePerspective( fov, window.innerWidth / window.innerHeight, camera.near, camera.far );
	
}

var mouseX = 0, mouseY = 0;

function onDocumentMouseMove( e ) {

	mouseX = 10 * ( .5 * window.innerWidth - e.pageX );
	mouseY = 10 * ( .5 * window.innerHeight - e.pageY );

}

var startTime = Date.now();

function render() {
	
	var t = Date.now();

	rS( 'frame' ).start();
    rS( 'rAF' ).tick();
    rS( 'FPS' ).frame();

    if( model ) {
	    /*model.rotation.x += .001;
	    model.rotation.y += .001;
	    model.rotation.z += .005;*/
	}
	camera.position.x += ( mouseX - camera.position.x ) * .05;
	camera.position.y += ( - mouseY - camera.position.y ) * .05;
	camera.lookAt( scene.position );

	model.material = depthMaterial;

	var k = Math.sin( .002 * t ) * .02 + .02;
	renderer.autoClearColor = true;
	composer.reset();
	composer.render( scene, camera );
	composer.toTexture( tmpTexture );

	model.material = modelMaterial;
	composer.render( scene, camera );

//	composer.pass( invertPass );
//	composer.pass( zoomBlurPass );
//	composer.pass( multiPassBloomPass );
//	composer.pass( denoisePass );
//	composer.pass( fullBoxBlurPass );
//	composer.pass( sepiaPass );
//	composer.pass( noisePass );
//	composer.pass( vignettePass );
//	composer.pass( vignette2Pass );
//	composer.pass( CGAPass );
//	composer.pass( edgeDetectionPass );
	
	if( guidedFullBoxBlurPass.isLoaded() ) {
		guidedFullBoxBlurPass.guidedBoxPass.shader.uniforms.tBias.value = tmpTexture;
	}
	composer.pass( guidedFullBoxBlurPass );
	composer.pass( multiPassBloomPass );
	composer.pass( dirtPass );

	composer.toScreen();

    rS( 'frame' ).end();
    rS().update();

	requestAnimationFrame( render );
	startTime = t;
	
}

</script>
		
	</body>
</html>
